<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Strength Training Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>
    <style>
      :root {
        /* Background colors */
        --bg-primary: #0a0a0a;
        --bg-secondary: #111;
        --bg-tertiary: #1a1a1a;
        --bg-hover: #222;

        /* Text colors */
        --text-primary: #e0e0e0;
        --text-bright: #fff;
        --text-muted: #888;
        --text-muted-light: #aaa;
        --text-muted-dark: #666;

        /* Accent colors */
        --accent-blue: #4a9eff;
        --accent-green: #51cf66;
        --accent-red: #ff6b6b;
        --accent-yellow: #ffd93d;
        --accent-gold: #ffd700;

        /* Lift-specific colors */
        --lift-squat: #4a9eff;
        --lift-bench: #ff6b6b;
        --lift-deadlift: #51cf66;
        --lift-ohp: #ffd93d;

        /* Border colors */
        --border-primary: #1a1a1a;
        --border-secondary: #333;
        --border-hover: #555;

        /* Spacing */
        --spacing-xs: 0.25rem;
        --spacing-sm: 0.5rem;
        --spacing-md: 1rem;
        --spacing-lg: 1.5rem;
        --spacing-xl: 2rem;
        --spacing-2xl: 4rem;

        /* Border radius */
        --radius-sm: 4px;
        --radius-md: 8px;
        --radius-lg: 20px;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family:
          -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          "Helvetica Neue", Arial, sans-serif;
        background: var(--bg-primary);
        color: var(--text-primary);
        line-height: 1.6;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: var(--spacing-xl);
      }

      header {
        text-align: center;
        padding: var(--spacing-2xl) 0 var(--spacing-xl);
        position: relative;
      }

      h1 {
        font-size: 3rem;
        font-weight: 800;
        letter-spacing: -0.02em;
        margin-bottom: var(--spacing-sm);
      }

      .tagline {
        font-size: 1.125rem;
        color: var(--text-muted);
        margin-bottom: var(--spacing-xl);
      }

      .unit-toggle {
        position: absolute;
        top: var(--spacing-xl);
        right: 0;
        background: var(--bg-tertiary);
        border: 1px solid var(--border-secondary);
        color: var(--text-primary);
        padding: var(--spacing-sm) var(--spacing-md);
        border-radius: var(--radius-lg);
        cursor: pointer;
        font-size: 0.875rem;
        transition: all 0.2s;
      }

      .unit-toggle:hover {
        background: var(--bg-hover);
        border-color: var(--border-hover);
      }

      nav {
        position: sticky;
        top: 0;
        background: var(--bg-primary);
        border-bottom: 1px solid var(--border-primary);
        padding: var(--spacing-md) 0;
        z-index: 100;
        margin-bottom: var(--spacing-xl);
      }

      nav ul {
        list-style: none;
        display: flex;
        gap: var(--spacing-lg);
        justify-content: center;
        flex-wrap: wrap;
      }

      nav a {
        color: var(--text-muted);
        text-decoration: none;
        font-size: 0.875rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        transition: color 0.2s;
      }

      nav a:hover {
        color: var(--accent-blue);
      }

      nav a.active {
        color: var(--text-primary);
      }

      section {
        margin: var(--spacing-2xl) 0;
        padding: var(--spacing-xl) 0;
        border-top: 1px solid var(--border-primary);
      }

      section:first-of-type {
        border-top: none;
      }

      h2 {
        font-size: 1.5rem;
        font-weight: 700;
        margin-bottom: var(--spacing-xl);
        color: var(--text-bright);
      }

      h3 {
        font-size: 1.25rem;
        font-weight: 600;
        margin: var(--spacing-xl) 0 var(--spacing-md);
        color: var(--text-bright);
      }

      .foreword {
        max-width: 800px;
        margin: 0 auto;
        font-size: 1rem;
        line-height: 1.8;
        color: var(--text-muted-light);
      }

      .summary-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: var(--spacing-xl);
        margin: 3rem 0;
      }

      .stat-card {
        text-align: center;
        padding: var(--spacing-lg);
        background: var(--bg-secondary);
        border-radius: var(--radius-md);
        border: 1px solid var(--border-primary);
      }

      .stat-number {
        font-size: 3rem;
        font-weight: 700;
        color: var(--text-bright);
        margin-bottom: var(--spacing-sm);
      }

      .stat-label {
        font-size: 0.875rem;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.05em;
      }

      /* Mini stat styles for inline replacement */
      .stat-mini {
        text-align: center;
      }

      .stat-mini-label {
        color: var(--text-muted-dark);
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin-bottom: var(--spacing-xs);
      }

      .stat-mini-value {
        color: var(--text-primary);
        font-size: 1.5rem;
        font-weight: 700;
      }

      .stat-mini-value.large {
        font-size: 2rem;
      }

      .stat-mini-value.accent-blue {
        color: var(--lift-squat);
      }

      .stat-mini-value.accent-red {
        color: var(--lift-bench);
      }

      .stat-mini-value.accent-green {
        color: var(--lift-deadlift);
      }

      .stat-mini-value.accent-gold {
        color: var(--accent-gold);
      }

      .stat-mini-detail {
        color: var(--text-muted-dark);
        font-size: 0.75rem;
        margin-top: var(--spacing-xs);
      }

      /* Lift stats grid */
      .lift-stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 1.5rem;
        text-align: center;
        margin-bottom: 2rem;
      }

      .lift-stats-grid.big-three-stats {
        margin-bottom: 1.5rem;
      }

      /* Powerlifting total display */
      .total-header {
        margin-top: 0;
        margin-bottom: 1.5rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .progress-indicator {
        margin-top: 1.5rem;
      }

      .progress-header {
        display: flex;
        justify-content: space-between;
        margin-bottom: 0.5rem;
      }

      .progress-label {
        color: var(--text-muted);
      }

      .progress-value {
        color: var(--accent-blue);
        font-weight: 600;
      }

      /* Club milestone section */
      .club-milestones {
        margin-top: 2rem;
      }

      .club-milestones h4 {
        margin-bottom: 1rem;
        color: var(--text-muted);
      }

      .club-milestone {
        border-left: 3px solid;
        padding-left: 1rem;
        margin: 0.5rem 0;
      }

      .club-milestone-text {
        margin-left: 0.5rem;
        color: var(--text-muted-dark);
      }

      /* Plate milestone grid */
      .plate-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 2rem;
      }

      .plate-lift-section h4 {
        margin-bottom: 1rem;
      }

      .plate-item {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.5rem 0;
        border-bottom: 1px solid var(--border-primary);
      }

      .plate-item.unachieved {
        opacity: 0.4;
      }

      .plate-icon {
        font-size: 1.25rem;
      }

      .plate-label {
        flex: 1;
      }

      .plate-date {
        color: var(--text-muted);
        font-size: 0.875rem;
      }

      /* Progress bar styles */
      .progress-bar {
        background: var(--bg-tertiary);
        height: 12px;
        border-radius: 6px;
        overflow: hidden;
      }

      .progress-fill {
        height: 100%;
        border-radius: 6px;
        transition: width 0.3s;
      }

      .progress-fill.accent-blue {
        background: var(--accent-blue);
      }

      /* Milestone and PR row styles */
      .milestone {
        display: flex;
        align-items: center;
        gap: var(--spacing-lg);
        padding: var(--spacing-sm) 0;
        border-bottom: 1px solid var(--border-primary);
      }

      .milestone:last-child {
        border-bottom: none;
      }

      .milestone-date {
        min-width: 100px;
        color: var(--text-muted);
        font-size: 0.875rem;
        flex-shrink: 0;
      }

      .milestone-text {
        color: var(--text-primary);
        flex: 1;
      }

      .milestone-item {
        border-left: 3px solid;
        padding-left: var(--spacing-md);
        margin: var(--spacing-sm) 0;
      }

      .pr-row {
        display: flex;
        justify-content: space-between;
        padding: 0.35rem 0;
        border-bottom: 1px solid var(--border-primary);
      }

      .pr-label {
        color: var(--text-muted);
      }

      .pr-value {
        color: var(--text-primary);
        font-weight: 600;
      }

      .chart-container {
        margin: var(--spacing-xl) 0;
        background: var(--bg-secondary);
        padding: var(--spacing-xl);
        border-radius: var(--radius-md);
        border: 1px solid var(--border-primary);
      }

      svg {
        width: 100%;
        height: auto;
      }

      .heatmap-cell {
        cursor: pointer;
      }

      .heatmap-cell:hover {
        stroke: var(--text-bright);
        stroke-width: 2;
      }

      .tooltip {
        position: absolute;
        background: var(--bg-tertiary);
        border: 1px solid var(--border-secondary);
        padding: var(--spacing-sm) var(--spacing-md);
        border-radius: var(--radius-sm);
        font-size: 0.875rem;
        pointer-events: none;
        z-index: 1000;
        display: none;
      }

      .notable-workout {
        background: var(--bg-secondary);
        padding: var(--spacing-md);
        margin: var(--spacing-sm) 0;
        border-radius: var(--radius-sm);
        border-left: 3px solid var(--accent-blue);
      }

      .notable-date {
        font-weight: 600;
        color: var(--accent-blue);
      }

      .milestone {
        display: flex;
        align-items: center;
        padding: 0.75rem 0;
        border-bottom: 1px solid var(--border-primary);
      }

      .milestone-date {
        min-width: 100px;
        color: var(--text-muted);
      }

      .milestone-text {
        color: var(--text-primary);
      }

      .program-card {
        background: var(--bg-secondary);
        padding: var(--spacing-lg);
        margin: var(--spacing-md) 0;
        border-radius: var(--radius-sm);
        border-left: 3px solid var(--text-muted);
      }

      .program-name {
        font-weight: 600;
        font-size: 1.125rem;
        margin-bottom: var(--spacing-sm);
      }

      .program-stats {
        display: flex;
        gap: var(--spacing-xl);
        margin-top: var(--spacing-sm);
        color: var(--text-muted);
        font-size: 0.875rem;
      }

      .view-toggle {
        display: flex;
        gap: var(--spacing-sm);
        margin-bottom: var(--spacing-md);
        justify-content: center;
      }

      .view-toggle button {
        background: var(--bg-tertiary);
        border: 1px solid var(--border-secondary);
        color: var(--text-muted);
        padding: var(--spacing-sm) var(--spacing-md);
        border-radius: var(--radius-sm);
        cursor: pointer;
        font-size: 0.875rem;
        transition: all 0.2s;
      }

      .view-toggle button:hover {
        border-color: var(--border-hover);
        color: var(--text-primary);
      }

      .view-toggle button.active {
        background: var(--accent-blue);
        border-color: var(--accent-blue);
        color: var(--text-bright);
      }

      @media (max-width: 768px) {
        .container {
          padding: var(--spacing-md);
        }

        h1 {
          font-size: 2rem;
        }

        .unit-toggle {
          position: static;
          display: block;
          margin: var(--spacing-md) auto 0;
          max-width: 150px;
        }

        .summary-stats {
          grid-template-columns: 1fr;
        }

        .stat-number {
          font-size: 2rem;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <h1>NO DAYS OFF</h1>
        <p class="tagline">
          A data-driven look at my strength training journey
        </p>
        <button class="unit-toggle" id="unitToggle">lbs / kg</button>
      </header>

      <nav>
        <ul>
          <li><a href="#summary">Summary</a></li>
          <li><a href="#volume-calendar">Volume & Calendar</a></li>
          <li><a href="#big-three">Big 3</a></li>
          <li><a href="#prs-clubs">PRs & Clubs</a></li>
          <li><a href="#exercises-patterns">Analysis</a></li>
          <li><a href="#history">History</a></li>
        </ul>
      </nav>

      <section>
        <div class="foreword">
          <p>
            This dashboard chronicles my strength training journey from January
            2019 onwards. Every rep, every set, every workout—tracked, analyzed,
            and visualized. The data tells the story of consistency,
            progression, and the relentless pursuit of strength.
          </p>
        </div>
      </section>

      <section id="summary">
        <h2>Summary</h2>
        <div class="summary-stats" id="summaryStats">
          <!-- Generated dynamically -->
        </div>
      </section>

      <section id="volume-calendar">
        <h2>Volume & Calendar</h2>
        <div class="chart-container">
          <h3>Volume Over Time</h3>
          <div class="view-toggle">
            <button data-view="weekly">Weekly</button>
            <button data-view="monthly" class="active">Monthly</button>
            <button data-view="yearly">Yearly</button>
            <button data-view="cumulative">Cumulative</button>
          </div>
          <canvas id="annualVolumeChart" style="max-height: 400px"></canvas>
        </div>
        <div class="chart-container">
          <h3>Workout Calendar</h3>
          <div id="workoutHeatmap"></div>
        </div>
      </section>

      <section id="big-three">
        <h2>Big 3 + OHP</h2>
        <div id="bigThreeCharts">
          <!-- Generated dynamically -->
        </div>
      </section>

      <section id="prs-clubs">
        <h2>PRs & Clubs</h2>
        <div id="prsClubsContent">
          <!-- Generated dynamically -->
        </div>
      </section>

      <section id="exercises-patterns">
        <h2>Exercise Analysis</h2>
        <div class="chart-container">
          <h3>Exercises by Volume</h3>
          <div id="exerciseVolumeChart"></div>
        </div>
        <div class="chart-container">
          <h3>Volume by Day of Week</h3>
          <div id="dayOfWeekChart"></div>
        </div>
      </section>

      <section id="history">
        <h2>Training History</h2>
        <h3>Programs</h3>
        <div id="programsList">
          <!-- Generated dynamically -->
        </div>
        <h3 style="margin-top: 3rem;">Notable Workouts</h3>
        <div id="notableWorkoutsList">
          <!-- Generated dynamically -->
        </div>
      </section>
    </div>

    <div class="tooltip" id="tooltip"></div>

    <script>
      // Global state
      let trainingData = null;
      let currentUnit = localStorage.getItem("weightUnit") || "lbs";
      let volumeView = localStorage.getItem("volumeView") || "monthly";

      // Load data and initialize dashboard
      async function init() {
        try {
          const response = await fetch(`training_data.json?v=${Date.now()}`);
          trainingData = await response.json();
          renderDashboard();
          setupUnitToggle();
          setupViewToggle();
        } catch (error) {
          console.error("Error loading training data:", error);
          document.querySelector(".container").innerHTML = `
                    <section style="text-align: center; padding: 4rem 2rem;">
                        <h2 style="color: #ff6b6b; margin-bottom: 1rem;">Unable to Load Data</h2>
                    </section>
                `;
        }
      }

      function setupUnitToggle() {
        const toggleButton = document.getElementById("unitToggle");
        updateToggleButton();

        toggleButton.addEventListener("click", () => {
          currentUnit = currentUnit === "lbs" ? "kg" : "lbs";
          localStorage.setItem("weightUnit", currentUnit);
          updateToggleButton();
          renderDashboard();
        });
      }

      function updateToggleButton() {
        const toggleButton = document.getElementById("unitToggle");
        toggleButton.textContent =
          currentUnit === "lbs" ? "switch to kg" : "switch to lbs";
      }

      function setupViewToggle() {
        const buttons = document.querySelectorAll(".view-toggle button");

        // Update active state
        function updateActiveButton() {
          buttons.forEach((btn) => {
            btn.classList.toggle("active", btn.dataset.view === volumeView);
          });
        }

        updateActiveButton();

        buttons.forEach((button) => {
          button.addEventListener("click", () => {
            volumeView = button.dataset.view;
            localStorage.setItem("volumeView", volumeView);
            updateActiveButton();
            renderAnnualVolumeChart();
          });
        });
      }

      function getVolume(volumeLbs, volumeKg) {
        return currentUnit === "lbs" ? volumeLbs : volumeKg;
      }

      function formatVolume(volumeLbs, volumeKg) {
        const volume = getVolume(volumeLbs, volumeKg);
        return `${volume.toLocaleString()} ${currentUnit}`;
      }

      function isoWeekToDate(weekString) {
        // Convert YYYY-Www format to date of Monday of that week
        const parts = weekString.match(/^(\d{4})-W(\d{2})$/);
        if (!parts) return weekString;

        const year = parseInt(parts[1]);
        const week = parseInt(parts[2]);

        // January 4th is always in week 1 (ISO 8601)
        const jan4 = new Date(year, 0, 4);
        const monday = new Date(jan4);
        monday.setDate(jan4.getDate() - (jan4.getDay() || 7) + 1);
        monday.setDate(monday.getDate() + (week - 1) * 7);

        return monday.toISOString().split("T")[0];
      }

      function createSVGElement(tag, attrs = {}) {
        const el = document.createElementNS('http://www.w3.org/2000/svg', tag);
        Object.entries(attrs).forEach(([key, value]) => {
          el.setAttribute(key, value);
        });
        return el;
      }

      function createSVGText(x, y, text, attrs = {}) {
        const el = createSVGElement('text', { x, y, ...attrs });
        el.textContent = text;
        return el;
      }

      function renderDashboard() {
        renderSummaryStats();
        renderAnnualVolumeChart();
        renderWorkoutHeatmap();
        renderBigThree();
        renderExerciseVolumeChart();
        renderPRsAndClubs();
        renderDayOfWeekChart();
        renderPrograms();
        renderNotableWorkouts();
      }

      function renderSummaryStats() {
        const { summary } = trainingData;
        const statsContainer = document.getElementById("summaryStats");

        const totalVolume = getVolume(
          summary.totalVolumeLbs,
          summary.totalVolumeKg,
        );
        const avgVolume = getVolume(
          summary.avgVolumePerWorkoutLbs,
          summary.avgVolumePerWorkoutKg,
        );
        const years = calculateYears(summary.firstWorkout, summary.lastWorkout);

        statsContainer.innerHTML = `
                <div class="stat-card">
                    <div class="stat-number">${summary.totalWorkouts}</div>
                    <div class="stat-label">Total Workouts</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${summary.workoutsPerWeekAvg}</div>
                    <div class="stat-label">Workouts/Week Avg</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${summary.totalTons.toLocaleString()}</div>
                    <div class="stat-label">Total Tons <span style="font-size: 0.6em; display: block; margin-top: 0.25rem;">(${Math.round(totalVolume / 1000)}K ${currentUnit})</span></div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${Math.round(summary.totalReps / 1000)}K</div>
                    <div class="stat-label">Total Reps</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${Math.round(avgVolume / 1000)}K</div>
                    <div class="stat-label">Avg Volume/Workout (${currentUnit})</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${summary.avgSetsPerWorkout}</div>
                    <div class="stat-label">Avg Sets/Workout</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${summary.avgWorkoutDuration}</div>
                    <div class="stat-label">Avg Duration (min)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${summary.totalHours}</div>
                    <div class="stat-label">Total Hours</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${years}</div>
                    <div class="stat-label">Years Training</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" style="font-size: 2rem;">${summary.bestMonthEver ? (() => { const [y, m] = summary.bestMonthEver.month.split('-'); const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec']; return months[parseInt(m)-1] + ' ' + y; })() : '—'}</div>
                    <div class="stat-label">Best Month <span style="font-size: 0.6em; display: block; margin-top: 0.25rem;">${summary.bestMonthEver ? Math.round(getVolume(summary.bestMonthEver.volumeLbs, summary.bestMonthEver.volumeKg) / 1000) + 'K ' + currentUnit : ''}</span></div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${summary.bestYearEver ? summary.bestYearEver.year : '—'}</div>
                    <div class="stat-label">Best Year <span style="font-size: 0.6em; display: block; margin-top: 0.25rem;">${summary.bestYearEver ? Math.round(getVolume(summary.bestYearEver.volumeLbs, summary.bestYearEver.volumeKg) / 1000) + 'K ' + currentUnit : ''}</span></div>
                </div>
            `;
      }

      function calculateYears(startDate, endDate) {
        const start = new Date(startDate);
        const end = new Date(endDate);
        const years = (end - start) / (1000 * 60 * 60 * 24 * 365.25);
        return years.toFixed(1);
      }

      let annualVolumeChartInstance = null;
      let bigThreeChartInstances = {};

      // Shared Chart.js Configuration
      const CHART_COLORS = {
        grid: "#1a1a1a",
        text: "#888",
        textBright: "#e0e0e0",
        tooltipBg: "#1a1a1a",
        tooltipBorder: "#333",
      };

      const CHART_DEFAULTS = {
        borderWidth: 2.5,
        pointRadius: 0,
        pointHoverRadius: 6,
        pointHoverBorderWidth: 2,
        tension: 0.4,
        hitRadius: 10,
      };

      const LIFT_CONFIG = {
        squat: { name: 'Squat', color: '#4a9eff', order: 0 },
        bench: { name: 'Bench Press', color: '#ff6b6b', order: 1 },
        deadlift: { name: 'Deadlift', color: '#51cf66', order: 2 },
        ohp: { name: 'Overhead Press', color: '#ffd93d', order: 3 }
      };

      const LIFT_ORDER = ['squat', 'bench', 'deadlift', 'ohp'];

      function getBaseChartOptions(overrides = {}) {
        return {
          responsive: true,
          maintainAspectRatio: true,
          plugins: {
            legend: {
              display: false,
              position: "top",
              labels: {
                color: CHART_COLORS.textBright,
                padding: 15,
                font: { size: 12 },
                usePointStyle: true,
                pointStyle: "line",
              },
              ...(overrides.legend || {}),
            },
            tooltip: {
              backgroundColor: CHART_COLORS.tooltipBg,
              titleColor: CHART_COLORS.textBright,
              bodyColor: CHART_COLORS.textBright,
              borderColor: CHART_COLORS.tooltipBorder,
              borderWidth: 1,
              titleFont: { size: 13, weight: "600" },
              bodyFont: { size: 12 },
              padding: 12,
              displayColors: false,
              ...(overrides.tooltip || {}),
            },
            ...(overrides.plugins || {}),
          },
          scales: {
            x: {
              grid: { color: CHART_COLORS.grid },
              ticks: {
                color: CHART_COLORS.text,
                font: { size: 11 },
                maxRotation: 45,
              },
              ...(overrides.x || {}),
            },
            y: {
              beginAtZero: false,
              grid: { color: CHART_COLORS.grid },
              ticks: {
                color: CHART_COLORS.text,
                font: { size: 11 },
              },
              ...(overrides.y || {}),
            },
          },
        };
      }

      function createLineDataset(label, data, color, overrides = {}) {
        return {
          label,
          data,
          borderColor: color,
          backgroundColor: color + "20",
          borderWidth: CHART_DEFAULTS.borderWidth,
          pointRadius: CHART_DEFAULTS.pointRadius,
          pointHoverRadius: CHART_DEFAULTS.pointHoverRadius,
          pointHoverBorderWidth: CHART_DEFAULTS.pointHoverBorderWidth,
          pointBackgroundColor: color,
          pointBorderColor: "#fff",
          hitRadius: CHART_DEFAULTS.hitRadius,
          tension: CHART_DEFAULTS.tension,
          fill: false,
          ...overrides,
        };
      }

      function renderAnnualVolumeChart() {
        const { volumeTimeSeries, bigThreeVolume } = trainingData;

        // Helper function to aggregate Big 3 volume data
        function aggregateBigThreeVolume(lift) {
          if (
            !bigThreeVolume ||
            !bigThreeVolume[lift] ||
            !bigThreeVolume[lift].dailyVolume
          ) {
            return [];
          }

          const dailyData = bigThreeVolume[lift].dailyVolume;

          if (volumeView === "cumulative") {
            let cumulativeTotal = 0;
            return dailyData.map((d) => {
              cumulativeTotal += getVolume(d.volumeLbs, d.volumeKg);
              return { x: d.date, y: cumulativeTotal };
            });
          } else if (volumeView === "weekly") {
            const weeklyData = {};
            dailyData.forEach((d) => {
              const date = new Date(d.date);
              const weekStart = new Date(date);
              weekStart.setDate(date.getDate() - date.getDay());
              const weekKey = weekStart.toISOString().split("T")[0];
              if (!weeklyData[weekKey]) {
                weeklyData[weekKey] = { volumeLbs: 0, volumeKg: 0 };
              }
              weeklyData[weekKey].volumeLbs += d.volumeLbs;
              weeklyData[weekKey].volumeKg += d.volumeKg;
            });
            return Object.entries(weeklyData).map(([date, vol]) => ({
              x: date,
              y: getVolume(vol.volumeLbs, vol.volumeKg),
            }));
          } else if (volumeView === "monthly") {
            const monthlyData = {};
            dailyData.forEach((d) => {
              const monthKey = d.date.substring(0, 7);
              if (!monthlyData[monthKey]) {
                monthlyData[monthKey] = { volumeLbs: 0, volumeKg: 0 };
              }
              monthlyData[monthKey].volumeLbs += d.volumeLbs;
              monthlyData[monthKey].volumeKg += d.volumeKg;
            });
            return Object.entries(monthlyData).map(([month, vol]) => ({
              x: month + "-01",
              y: getVolume(vol.volumeLbs, vol.volumeKg),
            }));
          } else if (volumeView === "yearly") {
            const yearlyData = {};
            dailyData.forEach((d) => {
              const year = d.date.substring(0, 4);
              if (!yearlyData[year]) {
                yearlyData[year] = { volumeLbs: 0, volumeKg: 0 };
              }
              yearlyData[year].volumeLbs += d.volumeLbs;
              yearlyData[year].volumeKg += d.volumeKg;
            });
            return Object.entries(yearlyData).map(([year, vol]) => ({
              x: year,
              y: getVolume(vol.volumeLbs, vol.volumeKg),
            }));
          }
          return [];
        }

        // Select data based on view mode
        let data, chartData, label, timeUnit, displayFormat;

        if (volumeView === "cumulative") {
          // Calculate cumulative volume from daily data
          data = volumeTimeSeries.daily;
          let cumulativeTotal = 0;
          chartData = data.map((d) => {
            cumulativeTotal += getVolume(d.volumeLbs, d.volumeKg);
            return {
              x: d.date,
              y: cumulativeTotal,
            };
          });
          label = `Total Volume (${currentUnit})`;
          timeUnit = "month";
          displayFormat = { month: "MMM yyyy" };
        } else if (volumeView === "weekly") {
          data = volumeTimeSeries.weekly;
          chartData = data.map((d) => ({
            x: isoWeekToDate(d.week),
            y: getVolume(d.volumeLbs, d.volumeKg),
          }));
          label = `Total Volume (${currentUnit})`;
          timeUnit = "month";
          displayFormat = { month: "MMM yyyy" };
        } else if (volumeView === "yearly") {
          data = volumeTimeSeries.yearly;
          chartData = data.map((d) => ({
            x: d.year.toString(),
            y: getVolume(d.volumeLbs, d.volumeKg),
          }));
          label = `Total Volume (${currentUnit})`;
          timeUnit = "year";
          displayFormat = { year: "yyyy" };
        } else {
          // monthly (default)
          data = volumeTimeSeries.monthly;
          chartData = data.map((d) => ({
            x: d.month + "-01",
            y: getVolume(d.volumeLbs, d.volumeKg),
          }));
          label = `Total Volume (${currentUnit})`;
          timeUnit = "month";
          displayFormat = { month: "MMM yyyy" };
        }

        if (data.length === 0) return;

        const canvas = document.getElementById("annualVolumeChart");
        const ctx = canvas.getContext("2d");

        // Destroy existing chart if it exists
        if (annualVolumeChartInstance) {
          annualVolumeChartInstance.destroy();
        }

        // Adjust visual settings based on view
        const isCumulative = volumeView === "cumulative";
        const isYearly = volumeView === "yearly";

        // Build datasets array with total volume + Big 3
        const datasets = [
          createLineDataset(label, chartData, "#888", {
            pointRadius: isYearly ? 6 : 0,
            pointHoverRadius: isYearly ? 8 : 6,
            fill: true,
            backgroundColor: "#88888833",
          }),
        ];

        // Add Big 3 datasets using centralized config
        LIFT_ORDER.forEach((lift) => {
          const config = LIFT_CONFIG[lift];
          const liftData = aggregateBigThreeVolume(lift);
          if (liftData.length > 0) {
            datasets.push(
              createLineDataset(config.name, liftData, config.color, {
                pointRadius: isYearly ? 4 : 0,
                pointHoverRadius: isYearly ? 6 : 4,
              }),
            );
          }
        });

        annualVolumeChartInstance = new Chart(ctx, {
          type: "line",
          data: { datasets },
          options: getBaseChartOptions({
            legend: {
              display: true,
              labels: {
                boxWidth: 12,
                boxHeight: 12,
                usePointStyle: false
              }
            },
            tooltip: {
              callbacks: {
                title: function (context) {
                  if (volumeView === "yearly") {
                    return context[0].label;
                  }
                  const date = new Date(context[0].parsed.x);
                  if (volumeView === "weekly") {
                    return date.toLocaleDateString("en-US", {
                      month: "short",
                      day: "numeric",
                      year: "numeric",
                    });
                  }
                  return date.toLocaleDateString("en-US", {
                    month: "long",
                    year: "numeric",
                  });
                },
                label: function (context) {
                  const volume = context.parsed.y;
                  const datasetLabel = context.dataset.label;
                  if (isCumulative) {
                    return `${datasetLabel}: ${(volume / 1000000).toFixed(2)}M ${currentUnit}`;
                  }
                  return `${datasetLabel}: ${(volume / 1000).toFixed(1)}K ${currentUnit}`;
                },
              },
            },
            x: {
              type: isYearly ? "category" : "time",
              time: !isYearly
                ? {
                    unit: timeUnit,
                    displayFormats: displayFormat,
                  }
                : undefined,
            },
            y: {
              beginAtZero: true,
              ticks: {
                callback: function (value) {
                  if (isCumulative && value >= 1000000) {
                    return (value / 1000000).toFixed(1) + "M";
                  }
                  return (value / 1000).toFixed(0) + "K";
                },
              },
            },
          }),
        });
      }

      function renderWorkoutHeatmap() {
        const { workoutCalendar } = trainingData;
        const container = document.getElementById("workoutHeatmap");

        // Get date range
        const dates = Object.keys(workoutCalendar).sort();
        if (dates.length === 0) return;

        const startDate = new Date(dates[0]);
        const endDate = new Date(dates[dates.length - 1]);

        // Group dates by year
        const yearRanges = {};
        for (
          let year = startDate.getFullYear();
          year <= endDate.getFullYear();
          year++
        ) {
          const yearStart = new Date(year, 0, 1);
          const yearEnd = new Date(year, 11, 31);
          yearRanges[year] = {
            start: year === startDate.getFullYear() ? startDate : yearStart,
            end: year === endDate.getFullYear() ? endDate : yearEnd,
          };
        }

        // Calculate dimensions
        const cellSize = 12;
        const cellPadding = 2;
        const leftMargin = 60;
        const topMargin = 20;
        const rowHeight = (cellSize + cellPadding) * 7 + 50; // Extra space for year header
        const yearGap = 25;
        const width = leftMargin + (cellSize + cellPadding) * 53 + 20; // Max 53 weeks per year
        const years = Object.keys(yearRanges).length;
        const height = topMargin + (rowHeight + yearGap) * years + 60; // Extra space for legend

        // Calculate volume percentiles for color scaling
        const volumes = dates.map((d) =>
          getVolume(workoutCalendar[d].volumeLbs, workoutCalendar[d].volumeKg),
        );
        const sortedVolumes = [...volumes]
          .filter((v) => v > 0)
          .sort((a, b) => a - b);
        const getColorLevel = (volume) => {
          if (volume === 0) return 0;
          const percentile =
            sortedVolumes.indexOf(sortedVolumes.find((v) => v >= volume)) /
            sortedVolumes.length;
          if (percentile < 0.2) return 1;
          if (percentile < 0.4) return 2;
          if (percentile < 0.6) return 3;
          if (percentile < 0.8) return 4;
          return 5;
        };

        const colors = [
          "#161616",
          "#0e4429",
          "#006d32",
          "#26a641",
          "#39d353",
          "#39d353",
        ];
        const monthNames = [
          "Jan",
          "Feb",
          "Mar",
          "Apr",
          "May",
          "Jun",
          "Jul",
          "Aug",
          "Sep",
          "Oct",
          "Nov",
          "Dec",
        ];

        const svg = document.createElementNS(
          "http://www.w3.org/2000/svg",
          "svg",
        );
        svg.setAttribute("viewBox", `0 0 ${width} ${height}`);

        // Calculate workout counts per year
        const yearWorkoutCounts = {};
        Object.keys(workoutCalendar).forEach((dateStr) => {
          const year = dateStr.substring(0, 4);
          yearWorkoutCounts[year] =
            (yearWorkoutCounts[year] || 0) + workoutCalendar[dateStr].count;
        });

        // Render each year as a separate row
        let rowIndex = 0;
        for (const [year, range] of Object.entries(yearRanges)) {
          const rowY = topMargin + rowIndex * (rowHeight + yearGap);

          // Year header with workout count
          const yearLabel = document.createElementNS(
            "http://www.w3.org/2000/svg",
            "text",
          );
          yearLabel.setAttribute("x", leftMargin);
          yearLabel.setAttribute("y", rowY + 15);
          yearLabel.setAttribute("fill", "#e0e0e0");
          yearLabel.setAttribute("font-size", "14");
          yearLabel.setAttribute("font-weight", "600");
          yearLabel.textContent = year;
          svg.appendChild(yearLabel);

          // Workout count for the year
          const workoutCount = yearWorkoutCounts[year] || 0;
          const countLabel = document.createElementNS(
            "http://www.w3.org/2000/svg",
            "text",
          );
          countLabel.setAttribute("x", leftMargin + 40);
          countLabel.setAttribute("y", rowY + 15);
          countLabel.setAttribute("fill", "#666");
          countLabel.setAttribute("font-size", "12");
          countLabel.textContent = `${workoutCount} workouts`;
          svg.appendChild(countLabel);

          // Separator line (except for first year)
          if (rowIndex > 0) {
            const line = document.createElementNS(
              "http://www.w3.org/2000/svg",
              "line",
            );
            line.setAttribute("x1", leftMargin);
            line.setAttribute("y1", rowY - yearGap / 2);
            line.setAttribute("x2", width - 20);
            line.setAttribute("y2", rowY - yearGap / 2);
            line.setAttribute("stroke", "#1a1a1a");
            line.setAttribute("stroke-width", "1");
            svg.appendChild(line);
          }

          // Weekday labels for this row
          const days = ["S", "M", "T", "W", "T", "F", "S"]; // Abbreviated
          days.forEach((day, i) => {
            const label = document.createElementNS(
              "http://www.w3.org/2000/svg",
              "text",
            );
            label.setAttribute("x", 48);
            label.setAttribute("y", rowY + 42 + i * (cellSize + cellPadding));
            label.setAttribute("text-anchor", "end");
            label.setAttribute("fill", "#888");
            label.setAttribute("font-size", "10");
            label.textContent = day;
            svg.appendChild(label);
          });

          // Start from the Sunday before Jan 1st
          const yearStart = new Date(parseInt(year), 0, 1);
          const adjustedStart = new Date(yearStart);
          adjustedStart.setDate(
            adjustedStart.getDate() - adjustedStart.getDay(),
          );

          const yearEnd = new Date(parseInt(year), 11, 31);
          const currentDate = new Date(adjustedStart);
          let weekIndex = 0;
          let lastMonth = -1;

          while (currentDate <= yearEnd) {
            const dateStr = currentDate.toISOString().split("T")[0];
            const dayOfWeek = currentDate.getDay();
            const month = currentDate.getMonth();
            const dateYear = currentDate.getFullYear();

            const x = leftMargin + weekIndex * (cellSize + cellPadding);
            const y = rowY + 35 + dayOfWeek * (cellSize + cellPadding);

            // Only draw cells for dates within the year and data range
            if (currentDate >= range.start && currentDate <= range.end) {
              const data = workoutCalendar[dateStr];
              const volume = data
                ? getVolume(data.volumeLbs, data.volumeKg)
                : 0;
              const colorLevel = getColorLevel(volume);

              const rect = document.createElementNS(
                "http://www.w3.org/2000/svg",
                "rect",
              );
              rect.setAttribute("x", x);
              rect.setAttribute("y", y);
              rect.setAttribute("width", cellSize);
              rect.setAttribute("height", cellSize);
              rect.setAttribute("fill", colors[colorLevel]);
              rect.setAttribute("class", "heatmap-cell");
              rect.setAttribute("data-date", dateStr);
              rect.setAttribute("data-volume", volume.toFixed(0));
              rect.setAttribute("data-workouts", data ? data.count : 0);

              rect.addEventListener("mouseenter", (e) =>
                showTooltip(e, dateStr, volume, data ? data.count : 0),
              );
              rect.addEventListener("mouseleave", hideTooltip);

              svg.appendChild(rect);
            }

            // Add month labels (only on Sundays, when month changes, and for current year)
            if (
              dayOfWeek === 0 &&
              month !== lastMonth &&
              dateYear === parseInt(year)
            ) {
              const monthLabel = document.createElementNS(
                "http://www.w3.org/2000/svg",
                "text",
              );
              monthLabel.setAttribute("x", x);
              monthLabel.setAttribute("y", rowY + 27);
              monthLabel.setAttribute("fill", "#aaa");
              monthLabel.setAttribute("font-size", "10");
              monthLabel.setAttribute("font-weight", "600");
              monthLabel.textContent = monthNames[month];
              svg.appendChild(monthLabel);
              lastMonth = month;
            }

            if (dayOfWeek === 6) weekIndex++;
            currentDate.setDate(currentDate.getDate() + 1);
          }

          rowIndex++;
        }

        // Add color legend at the bottom
        const legendY = height - 40;
        const legendX = width - 200;

        const legendLabel = document.createElementNS(
          "http://www.w3.org/2000/svg",
          "text",
        );
        legendLabel.setAttribute("x", legendX - 40);
        legendLabel.setAttribute("y", legendY + 10);
        legendLabel.setAttribute("fill", "#888");
        legendLabel.setAttribute("font-size", "10");
        legendLabel.textContent = "Less";
        svg.appendChild(legendLabel);

        // Legend boxes
        for (let i = 0; i < 5; i++) {
          const rect = document.createElementNS(
            "http://www.w3.org/2000/svg",
            "rect",
          );
          rect.setAttribute("x", legendX + i * 16);
          rect.setAttribute("y", legendY);
          rect.setAttribute("width", cellSize);
          rect.setAttribute("height", cellSize);
          rect.setAttribute("fill", colors[i + 1]);
          rect.setAttribute("stroke", "#1a1a1a");
          rect.setAttribute("stroke-width", "1");
          svg.appendChild(rect);
        }

        const legendLabel2 = document.createElementNS(
          "http://www.w3.org/2000/svg",
          "text",
        );
        legendLabel2.setAttribute("x", legendX + 85);
        legendLabel2.setAttribute("y", legendY + 10);
        legendLabel2.setAttribute("fill", "#888");
        legendLabel2.setAttribute("font-size", "10");
        legendLabel2.textContent = "More";
        svg.appendChild(legendLabel2);

        container.innerHTML = "";
        container.appendChild(svg);
      }

      function showTooltip(e, date, volume, workouts) {
        const tooltip = document.getElementById("tooltip");
        tooltip.style.display = "block";
        tooltip.innerHTML = `
                <strong>${date}</strong><br>
                Workouts: ${workouts}<br>
                Volume: ${volume.toLocaleString()} ${currentUnit}
            `;
        tooltip.style.left = e.pageX + 10 + "px";
        tooltip.style.top = e.pageY + 10 + "px";
      }

      function hideTooltip() {
        document.getElementById("tooltip").style.display = "none";
      }

      function renderBigThree() {
        const { bigThreeE1RM, daysSinceLastPR } = trainingData;
        const container = document.getElementById("bigThreeCharts");
        container.innerHTML = "";

        if (!bigThreeE1RM || Object.keys(bigThreeE1RM).length === 0) {
          container.innerHTML =
            '<p style="color: #888;">No Big 3 data available</p>';
          return;
        }

        LIFT_ORDER.forEach((lift) => {
          const config = LIFT_CONFIG[lift];
          const hasE1RM =
            bigThreeE1RM &&
            bigThreeE1RM[lift] &&
            bigThreeE1RM[lift].e1rmHistory &&
            bigThreeE1RM[lift].e1rmHistory.length > 0;

          if (!hasE1RM) return;

          const e1rmData = bigThreeE1RM[lift];
          const daysSince = daysSinceLastPR && daysSinceLastPR[lift] !== null ? daysSinceLastPR[lift] : null;

          const chartDiv = document.createElement("div");
          chartDiv.className = "chart-container";

          const title = document.createElement("h3");
          title.textContent = config.name;
          title.style.marginTop = "0";
          title.style.marginBottom = "1rem";
          chartDiv.appendChild(title);

          // Show key stats
          const stats = document.createElement("div");
          stats.className = "lift-stats-grid big-three-stats";

          if (hasE1RM) {
            const history = e1rmData.e1rmHistory;
            const latest = history[history.length - 1];
            const peak = history.reduce((max, point) =>
              getVolume(point.e1rmLbs, point.e1rmKg) >
              getVolume(max.e1rmLbs, max.e1rmKg)
                ? point
                : max,
            );
            const first = history[0];

            const currentE1RM = Math.round(
              getVolume(latest.e1rmLbs, latest.e1rmKg),
            );
            const peakE1RM = Math.round(getVolume(peak.e1rmLbs, peak.e1rmKg));
            const startE1RM = Math.round(
              getVolume(first.e1rmLbs, first.e1rmKg),
            );
            const totalGain = currentE1RM - startE1RM;
            const gainPercent = ((totalGain / startE1RM) * 100).toFixed(0);

            // Days since last PR with color coding
            let daysSinceHTML = '';
            if (daysSince !== null) {
              const color = daysSince < 30 ? '#51cf66' : daysSince < 90 ? '#ffd93d' : '#ff6b6b';
              const label = daysSince === 0 ? 'Today!' : daysSince === 1 ? '1 day ago' : `${daysSince} days ago`;
              daysSinceHTML = `
                <div>
                  <div class="stat-mini-label">Last PR</div>
                  <div class="stat-mini-value" style="color: ${color};">${label}</div>
                </div>
              `;
            }

            stats.innerHTML = `
                        <div>
                            <div class="stat-mini-label">Starting e1RM</div>
                            <div class="stat-mini-value">${startE1RM} ${currentUnit}</div>
                            <div class="stat-mini-detail">${new Date(first.date).toLocaleDateString("en-US", { month: "short", year: "numeric" })}</div>
                        </div>
                        <div>
                            <div class="stat-mini-label">Current e1RM</div>
                            <div class="stat-mini-value">${currentE1RM} ${currentUnit}</div>
                            <div class="stat-mini-detail">${new Date(latest.date).toLocaleDateString("en-US", { month: "short", year: "numeric" })}</div>
                        </div>
                        <div>
                            <div class="stat-mini-label">Peak e1RM</div>
                            <div class="stat-mini-value">${peakE1RM} ${currentUnit}</div>
                            <div class="stat-mini-detail">${new Date(peak.date).toLocaleDateString("en-US", { month: "short", year: "numeric" })}</div>
                        </div>
                        <div>
                            <div class="stat-mini-label">Total Gain</div>
                            <div class="stat-mini-value accent-green">+${totalGain} ${currentUnit}</div>
                            <div class="stat-mini-detail" style="color: #51cf66;">+${gainPercent}%</div>
                        </div>
                        ${daysSinceHTML}
                    `;
          }
          chartDiv.appendChild(stats);

          // Create canvas for Chart.js
          const canvas = document.createElement("canvas");
          canvas.id = `${lift}Chart`;
          canvas.style.maxHeight = "350px";
          chartDiv.appendChild(canvas);

          container.appendChild(chartDiv);

          // Render chart after DOM update
          setTimeout(
            () =>
              renderBigThreeChart(
                lift,
                e1rmData.e1rmHistory || [],
                config.color,
              ),
            0,
          );
        });

        if (container.children.length === 0) {
          container.innerHTML =
            '<p style="color: #888;">No Big 3 data available</p>';
        }
      }

      function renderBigThreeChart(lift, e1rmHistory, color) {
        const canvas = document.getElementById(`${lift}Chart`);
        if (!canvas) return;

        // Destroy existing chart if it exists
        if (bigThreeChartInstances[lift]) {
          bigThreeChartInstances[lift].destroy();
        }

        const ctx = canvas.getContext("2d");
        const datasets = [];

        // Get PRs from allTimePRs
        const allTimePRs = trainingData.allTimePRs;
        const liftPRs = allTimePRs && allTimePRs[lift] && allTimePRs[lift].repPRs ? allTimePRs[lift].repPRs : {};

        // Show e1RM progression
        if (e1rmHistory && e1rmHistory.length > 0) {
          const e1rmData = e1rmHistory.map((point) => ({
            x: point.date,
            y: getVolume(point.e1rmLbs, point.e1rmKg),
            actualWeight: getVolume(
              point.actualWeightLbs,
              point.actualWeightKg,
            ),
            reps: point.reps,
          }));

          datasets.push(
            createLineDataset("Estimated 1RM", e1rmData, color, {
              backgroundColor: color + "15",
              fill: true,
            }),
          );
        }

        // Add actual PR markers from allTimePRs (show max weight for key rep ranges)
        if (Object.keys(liftPRs).length > 0) {
          // Only show PRs for key rep ranges (1, 3, 5, 8, 10)
          const keyRepRanges = [1, 3, 5, 8, 10];
          const prData = [];

          keyRepRanges.forEach(reps => {
            if (liftPRs[reps]) {
              // Find the date when this PR was achieved from e1rmHistory
              const prEntry = e1rmHistory.find(entry =>
                entry.reps === reps &&
                Math.abs(getVolume(entry.actualWeightLbs, entry.actualWeightKg) - getVolume(liftPRs[reps].weightLbs, liftPRs[reps].weightKg)) < 0.1
              );

              if (prEntry) {
                prData.push({
                  x: prEntry.date,
                  y: getVolume(liftPRs[reps].weightLbs, liftPRs[reps].weightKg),
                  reps: reps,
                  isPR: true,
                });
              }
            }
          });

          if (prData.length > 0) {
            datasets.push({
              label: "Key PRs",
              data: prData,
              type: "scatter",
              backgroundColor: "#ffd700",
              borderColor: "#fff",
              borderWidth: 2,
              pointRadius: 8,
              pointHoverRadius: 10,
              pointStyle: "circle",
              showLine: false,
              order: 0,
            });
          }
        }

        // Plate milestones for reference lines (in lbs, convert if kg)
        const plateMilestonesLbs = [135, 225, 315, 405, 495];
        const plateMilestonesKg = [60, 100, 140, 180, 220];
        const plateMilestones =
          currentUnit === "lbs" ? plateMilestonesLbs : plateMilestonesKg;
        const plateLabels =
          currentUnit === "lbs"
            ? ["1 plate", "2 plates", "3 plates", "4 plates", "5 plates"]
            : ["60kg", "100kg", "140kg", "180kg", "220kg"];

        // Get y-axis range from data to filter relevant milestones
        const yValues = e1rmHistory.map((p) => getVolume(p.e1rmLbs, p.e1rmKg));
        const minY = Math.min(...yValues);
        const maxY = Math.max(...yValues);
        const yPadding = (maxY - minY) * 0.1;

        // Create annotation lines for plate milestones within data range
        const annotations = {};
        plateMilestones.forEach((weight, i) => {
          if (weight >= minY - yPadding && weight <= maxY + yPadding) {
            annotations[`plate${i}`] = {
              type: "line",
              yMin: weight,
              yMax: weight,
              borderColor: "#ffffff22",
              borderWidth: 1,
              borderDash: [5, 5],
              label: {
                display: true,
                content: plateLabels[i],
                position: "end",
                backgroundColor: "transparent",
                color: "#666",
                font: { size: 10 },
              },
            };
          }
        });

        bigThreeChartInstances[lift] = new Chart(ctx, {
          type: "line",
          data: { datasets },
          options: getBaseChartOptions({
            plugins: {
              annotation: {
                annotations: annotations,
              },
            },
            tooltip: {
              callbacks: {
                title: function (context) {
                  const date = new Date(context[0].parsed.x);
                  return date.toLocaleDateString("en-US", {
                    month: "short",
                    day: "numeric",
                    year: "numeric",
                  });
                },
                label: function (context) {
                  const value = context.parsed.y;
                  if (context.raw.isPR) {
                    return `🏆 PR: ${value} ${currentUnit} × ${context.raw.reps} reps`;
                  }
                  return `Estimated 1RM: ${value} ${currentUnit}`;
                },
                afterLabel: function (context) {
                  if (context.raw.actualWeight && !context.raw.isPR) {
                    return `From: ${context.raw.actualWeight} ${currentUnit} × ${context.raw.reps} reps`;
                  }
                  return "";
                },
              },
            },
            x: {
              type: "time",
              time: {
                unit: "month",
                displayFormats: { month: "MMM yyyy" },
              },
            },
            y: {
              ticks: {
                callback: function (value) {
                  return value + " " + currentUnit;
                },
              },
            },
          }),
        });
      }

      function renderExerciseVolumeChart() {
        const { exerciseProgress } = trainingData;
        const container = document.getElementById("exerciseVolumeChart");

        // Sort exercises by volume and take top 15
        const exercises = Object.entries(exerciseProgress)
          .map(([name, data]) => ({
            name,
            volume: getVolume(data.totalVolumeLbs, data.totalVolumeKg),
          }))
          .sort((a, b) => b.volume - a.volume)
          .slice(0, 15);

        if (exercises.length === 0) return;

        const width = container.offsetWidth;
        const height = exercises.length * 35 + 60;
        const padding = { top: 20, right: 100, bottom: 40, left: 200 };

        const maxVolume = Math.max(...exercises.map((e) => e.volume));

        const svg = document.createElementNS(
          "http://www.w3.org/2000/svg",
          "svg",
        );
        svg.setAttribute("viewBox", `0 0 ${width} ${height}`);

        exercises.forEach((exercise, i) => {
          const y = padding.top + i * 35;
          const barWidth =
            (exercise.volume / maxVolume) *
            (width - padding.left - padding.right);

          // Bar
          const rect = document.createElementNS(
            "http://www.w3.org/2000/svg",
            "rect",
          );
          rect.setAttribute("x", padding.left);
          rect.setAttribute("y", y);
          rect.setAttribute("width", barWidth);
          rect.setAttribute("height", 25);
          rect.setAttribute("fill", "#4a9eff");
          svg.appendChild(rect);

          // Exercise name
          const label = document.createElementNS(
            "http://www.w3.org/2000/svg",
            "text",
          );
          label.setAttribute("x", padding.left - 10);
          label.setAttribute("y", y + 17);
          label.setAttribute("text-anchor", "end");
          label.setAttribute("fill", "#e0e0e0");
          label.setAttribute("font-size", "12");
          label.textContent = exercise.name;
          svg.appendChild(label);

          // Volume label
          const volumeLabel = document.createElementNS(
            "http://www.w3.org/2000/svg",
            "text",
          );
          volumeLabel.setAttribute("x", padding.left + barWidth + 10);
          volumeLabel.setAttribute("y", y + 17);
          volumeLabel.setAttribute("fill", "#888");
          volumeLabel.setAttribute("font-size", "12");
          volumeLabel.textContent = `${Math.round(exercise.volume / 1000)}K`;
          svg.appendChild(volumeLabel);
        });

        container.innerHTML = "";
        container.appendChild(svg);
      }

      function renderPRsAndClubs() {
        const { powerliftingTotals, plateMilestones, allTimePRs } =
          trainingData;
        const container = document.getElementById("prsClubsContent");

        if (!powerliftingTotals && !plateMilestones && !allTimePRs) {
          container.innerHTML =
            '<p style="color: #888;">No PR data available</p>';
          return;
        }

        let html = "";

        // 1000 lb Club Section
        if (powerliftingTotals && powerliftingTotals.current) {
          const current = powerliftingTotals.current;
          const peak = powerliftingTotals.peak;
          const clubs = powerliftingTotals.clubMilestones || {};

          const totalValue =
            currentUnit === "lbs" ? current.totalLbs : current.totalKg;
          const peakValue = peak
            ? currentUnit === "lbs"
              ? peak.totalLbs
              : peak.totalKg
            : totalValue;
          const squatValue =
            currentUnit === "lbs"
              ? current.squatE1rm
              : Math.round(current.squatE1rm * 0.453592);
          const benchValue =
            currentUnit === "lbs"
              ? current.benchE1rm
              : Math.round(current.benchE1rm * 0.453592);
          const deadliftValue =
            currentUnit === "lbs"
              ? current.deadliftE1rm
              : Math.round(current.deadliftE1rm * 0.453592);

          // Determine club status
          const clubThresholds = [
            {
              threshold: 1500,
              name: "1500 lb Club",
              color: "#ffd700",
              emoji: "👑",
            },
            {
              threshold: 1400,
              name: "1400 lb Club",
              color: "#e6b800",
              emoji: "👑",
            },
            {
              threshold: 1300,
              name: "1300 lb Club",
              color: "#d4af37",
              emoji: "💪",
            },
            {
              threshold: 1200,
              name: "1200 lb Club",
              color: "#c0c0c0",
              emoji: "💪",
            },
            {
              threshold: 1100,
              name: "1100 lb Club",
              color: "#b8860b",
              emoji: "🏆",
            },
            {
              threshold: 1000,
              name: "1000 lb Club",
              color: "#cd7f32",
              emoji: "🏆",
            },
            {
              threshold: 750,
              name: "750 lb Club",
              color: "#4a9eff",
              emoji: "💎",
            },
            {
              threshold: 500,
              name: "500 lb Club",
              color: "#51cf66",
              emoji: "⭐",
            },
          ];

          const achievedClub = clubThresholds.find(
            (c) => current.totalLbs >= c.threshold,
          );
          const nextClub = clubThresholds
            .slice()
            .reverse()
            .find((c) => current.totalLbs < c.threshold);

          html += `<div class="chart-container">`;
          html += `<h3 class="total-header">
                    ${achievedClub ? achievedClub.emoji : "🎯"} Powerlifting Total (S+B+D)
                </h3>`;

          // Current total display
          html += `<div class="lift-stats-grid">`;

          html += `
                    <div>
                        <div class="stat-mini-label">Current Total</div>
                        <div class="stat-mini-value large" style="color: ${achievedClub ? achievedClub.color : "#e0e0e0"};">${Math.round(totalValue)} ${currentUnit}</div>
                        ${achievedClub ? `<div class="stat-mini-detail" style="color: ${achievedClub.color};">${achievedClub.name}</div>` : ""}
                    </div>
                    <div>
                        <div class="stat-mini-label">Squat e1RM</div>
                        <div class="stat-mini-value accent-blue">${Math.round(squatValue)} ${currentUnit}</div>
                    </div>
                    <div>
                        <div class="stat-mini-label">Bench e1RM</div>
                        <div class="stat-mini-value accent-red">${Math.round(benchValue)} ${currentUnit}</div>
                    </div>
                    <div>
                        <div class="stat-mini-label">Deadlift e1RM</div>
                        <div class="stat-mini-value accent-green">${Math.round(deadliftValue)} ${currentUnit}</div>
                    </div>
                </div>`;

          // Next club progress
          if (nextClub) {
            const remaining = nextClub.threshold - current.totalLbs;
            const progressPercent =
              (current.totalLbs / nextClub.threshold) * 100;
            html += `
                        <div class="progress-indicator">
                            <div class="progress-header">
                                <span class="progress-label">Progress to ${nextClub.name}</span>
                                <span class="progress-value">${Math.round(remaining)} lbs to go</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill accent-blue" style="width: ${Math.min(progressPercent, 100)}%;"></div>
                            </div>
                        </div>
                    `;
          }

          // Club milestones achieved
          const achievedMilestones = Object.entries(clubs).sort(
            (a, b) => parseInt(b[0]) - parseInt(a[0]),
          );
          if (achievedMilestones.length > 0) {
            html += `<div class="club-milestones"><h4>Club Milestones Achieved</h4>`;
            achievedMilestones.forEach(([threshold, data]) => {
              const club = clubThresholds.find(
                (c) => c.threshold === parseInt(threshold),
              );
              if (club && data) {
                html += `
                                <div class="milestone">
                                    <div class="milestone-date">${data.date}</div>
                                    <div class="milestone-text">
                                        <span style="color: ${club.color};">${club.emoji} ${club.name}</span>
                                        <span class="club-milestone-text">(S:${Math.round(data.squat)} B:${Math.round(data.bench)} D:${Math.round(data.deadlift)} = ${Math.round(data.totalLbs)} lbs)</span>
                                    </div>
                                </div>
                            `;
              }
            });
            html += `</div>`;
          }

          // Add volume and workout milestones
          const { milestones, summary } = trainingData;
          if (milestones && milestones.length > 0) {
            html += `<div class="club-milestones"><h4>Volume & Workout Milestones</h4>`;
            [...milestones].reverse().slice(0, 10).forEach((m) => {
              html += `
                <div class="milestone">
                  <div class="milestone-date">${m.date}</div>
                  <div class="milestone-text">${m.icon} ${m.milestone}</div>
                </div>
              `;
            });
            html += `</div>`;
          }

          html += `</div>`;
        }

        // Plate Milestones Section
        if (plateMilestones && Object.keys(plateMilestones).length > 0) {
          const plateLabels = {
            1: "1 Plate (135)",
            2: "2 Plates (225)",
            3: "3 Plates (315)",
            4: "4 Plates (405)",
            5: "5 Plates (495)",
          };

          html += `<div class="chart-container">`;
          html += `<h3>🏅 Plate Milestones</h3>`;

          html += `<div class="plate-grid">`;

          LIFT_ORDER.forEach((lift) => {
            const config = LIFT_CONFIG[lift];
            const liftData = plateMilestones[lift] || {};
            const maxPlates = Math.max(...Object.keys(liftData).map(Number), 0);

            html += `<div class="plate-lift-section">`;
            html += `<h4 style="color: ${config.color};">${config.name}</h4>`;

            [1, 2, 3, 4, 5].forEach((plates) => {
              const achieved = liftData[plates];
              const plateWeight =
                currentUnit === "lbs"
                  ? plates * 90 + 45
                  : Math.round((plates * 90 + 45) * 0.453592);
              const plateLabel =
                currentUnit === "lbs"
                  ? `${plates} plate${plates > 1 ? "s" : ""} (${plates * 90 + 45})`
                  : `${plates} plate${plates > 1 ? "s" : ""} (${plateWeight}kg)`;

              if (achieved) {
                html += `
                                <div class="plate-item">
                                    <span class="plate-icon">✅</span>
                                    <span class="plate-label">${plateLabel}</span>
                                    <span class="plate-date">${achieved.date}</span>
                                </div>
                            `;
              } else {
                html += `
                                <div class="plate-item unachieved">
                                    <span class="plate-icon">⬜</span>
                                    <span class="plate-label" style="color: var(--text-muted);">${plateLabel}</span>
                                    <span class="plate-date">—</span>
                                </div>
                            `;
              }
            });

            html += `</div>`;
          });

          html += `</div></div>`;
        }

        // All-Time PRs Section
        if (allTimePRs && Object.keys(allTimePRs).length > 0) {
          html += `<div class="chart-container">`;
          html += `<h3 style="margin-top: 0; margin-bottom: 1.5rem;">🏆 All-Time PRs</h3>`;

          html += `<div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 2rem;">`;

          LIFT_ORDER.forEach((lift) => {
            const config = LIFT_CONFIG[lift];
            const liftData = allTimePRs[lift];
            if (!liftData) return;

            const maxEver = liftData.maxEver;
            const bestE1rm = liftData.bestE1rm;
            const repPRs = liftData.repPRs || {};

            html += `<div>`;
            html += `<h4 style="color: ${config.color}; margin-bottom: 1rem;">${config.name}</h4>`;

            // Best e1RM
            if (bestE1rm) {
              const e1rmValue =
                currentUnit === "lbs" ? bestE1rm.e1rmLbs : bestE1rm.e1rmKg;
              html += `
                            <div style="background: #111; border: 1px solid ${config.color}44; border-radius: 8px; padding: 1rem; margin-bottom: 1rem; text-align: center;">
                                <div style="color: #888; font-size: 0.75rem; text-transform: uppercase; margin-bottom: 0.25rem;">Best e1RM</div>
                                <div style="color: ${config.color}; font-size: 1.75rem; font-weight: 700;">${Math.round(e1rmValue)} ${currentUnit}</div>
                            </div>
                        `;
            }

            // Rep PRs table
            const sortedReps = Object.keys(repPRs)
              .map(Number)
              .sort((a, b) => a - b);
            if (sortedReps.length > 0) {
              html += `<div style="font-size: 0.875rem;">`;
              sortedReps.forEach((reps) => {
                const pr = repPRs[reps];
                const weight =
                  currentUnit === "lbs" ? pr.weightLbs : pr.weightKg;
                html += `
                                <div style="display: flex; justify-content: space-between; padding: 0.35rem 0; border-bottom: 1px solid #1a1a1a;">
                                    <span style="color: #888;">${reps}RM</span>
                                    <span style="color: #e0e0e0; font-weight: 600;">${Math.round(weight)} ${currentUnit}</span>
                                </div>
                            `;
              });
              html += `</div>`;
            }

            html += `</div>`;
          });

          html += `</div></div>`;
        }

        container.innerHTML = html;
      }

      function renderDayOfWeekChart() {
        const { workoutsByDayOfWeek } = trainingData;
        const container = document.getElementById("dayOfWeekChart");

        const dayOrder = [
          "Monday",
          "Tuesday",
          "Wednesday",
          "Thursday",
          "Friday",
          "Saturday",
          "Sunday",
        ];
        const data = dayOrder
          .filter((day) => workoutsByDayOfWeek[day])
          .map((day) => ({
            day,
            volume: getVolume(
              workoutsByDayOfWeek[day].avgVolumeLbs,
              workoutsByDayOfWeek[day].avgVolumeKg,
            ),
            count: workoutsByDayOfWeek[day].count,
          }));

        if (data.length === 0) return;

        const width = container.offsetWidth;
        const height = 400;
        const padding = { top: 40, right: 40, bottom: 80, left: 80 };

        const maxVolume = Math.max(...data.map((d) => d.volume));
        const barWidth = (width - padding.left - padding.right) / data.length;

        const svg = document.createElementNS(
          "http://www.w3.org/2000/svg",
          "svg",
        );
        svg.setAttribute("viewBox", `0 0 ${width} ${height}`);

        // Grid lines
        for (let i = 0; i <= 5; i++) {
          const y =
            padding.top + (i / 5) * (height - padding.top - padding.bottom);
          const line = document.createElementNS(
            "http://www.w3.org/2000/svg",
            "line",
          );
          line.setAttribute("x1", padding.left);
          line.setAttribute("y1", y);
          line.setAttribute("x2", width - padding.right);
          line.setAttribute("y2", y);
          line.setAttribute("stroke", "#1a1a1a");
          svg.appendChild(line);
        }

        data.forEach((d, i) => {
          const x = padding.left + i * barWidth;
          const barHeight =
            (d.volume / maxVolume) * (height - padding.top - padding.bottom);
          const y = height - padding.bottom - barHeight;

          // Bar (with reduced opacity if very few workouts)
          const rect = document.createElementNS(
            "http://www.w3.org/2000/svg",
            "rect",
          );
          rect.setAttribute("x", x + barWidth * 0.1);
          rect.setAttribute("y", y);
          rect.setAttribute("width", barWidth * 0.8);
          rect.setAttribute("height", barHeight);
          // Use reduced opacity for days with < 10 workouts
          rect.setAttribute("fill", d.count < 10 ? "#4a9eff66" : "#4a9eff");

          // Add hover effect
          rect.addEventListener("mouseenter", (e) => {
            const tooltip = document.getElementById("tooltip");
            tooltip.style.display = "block";
            tooltip.innerHTML = `
                        <strong>${d.day}</strong><br>
                        ${d.count} workout${d.count !== 1 ? "s" : ""}<br>
                        Avg volume: ${Math.round(d.volume).toLocaleString()} ${currentUnit}
                    `;
            tooltip.style.left = e.pageX + 10 + "px";
            tooltip.style.top = e.pageY + 10 + "px";
          });
          rect.addEventListener("mouseleave", hideTooltip);

          svg.appendChild(rect);

          // Workout count label (above bar)
          const countLabel = document.createElementNS(
            "http://www.w3.org/2000/svg",
            "text",
          );
          countLabel.setAttribute("x", x + barWidth / 2);
          countLabel.setAttribute("y", y - 8);
          countLabel.setAttribute("text-anchor", "middle");
          countLabel.setAttribute("fill", d.count < 10 ? "#666" : "#aaa");
          countLabel.setAttribute("font-size", "11");
          countLabel.setAttribute(
            "font-weight",
            d.count < 10 ? "normal" : "600",
          );
          countLabel.textContent = `${d.count}×`;
          svg.appendChild(countLabel);

          // Day label
          const label = document.createElementNS(
            "http://www.w3.org/2000/svg",
            "text",
          );
          label.setAttribute("x", x + barWidth / 2);
          label.setAttribute("y", height - padding.bottom + 20);
          label.setAttribute("text-anchor", "middle");
          label.setAttribute("fill", "#888");
          label.setAttribute("font-size", "12");
          label.textContent = d.day.substring(0, 3);
          svg.appendChild(label);

          // Add note for low-frequency days
          if (d.count < 10) {
            const noteLabel = document.createElementNS(
              "http://www.w3.org/2000/svg",
              "text",
            );
            noteLabel.setAttribute("x", x + barWidth / 2);
            noteLabel.setAttribute("y", height - padding.bottom + 35);
            noteLabel.setAttribute("text-anchor", "middle");
            noteLabel.setAttribute("fill", "#666");
            noteLabel.setAttribute("font-size", "9");
            noteLabel.textContent = "(rare)";
            svg.appendChild(noteLabel);
          }
        });

        container.innerHTML = "";
        container.appendChild(svg);
      }

      function renderPrograms() {
        const { programs } = trainingData;
        const container = document.getElementById("programsList");

        if (!programs || programs.length === 0) {
          container.innerHTML = '<p style="color: var(--text-muted);">No programs found</p>';
          return;
        }

        container.innerHTML = programs
          .map(
            (program) => `
                <div class="program-card">
                    <div class="program-name">${program.name}</div>
                    <div>${program.startDate} → ${program.endDate}</div>
                    <div class="program-stats">
                        <span>${program.workouts} workouts</span>
                        <span>${formatVolume(program.totalVolumeLbs, program.totalVolumeKg)} total volume</span>
                        <span style="color: #ffd700;">${program.prsSet || 0} PRs set</span>
                    </div>
                </div>
            `,
          )
          .join("");
      }

      function renderNotableWorkouts() {
        const { notableWorkouts } = trainingData;
        const container = document.getElementById("notableWorkoutsList");

        if (!notableWorkouts || notableWorkouts.length === 0) {
          container.innerHTML = '<p style="color: var(--text-muted);">No notable workouts found</p>';
          return;
        }

        // Group by category
        const volumeRecords = notableWorkouts.filter(w => w.category === 'volume');
        const setRecords = notableWorkouts.filter(w => w.category === 'sets');
        const comebacks = notableWorkouts.filter(w => w.category === 'comeback');

        let html = '';

        // Volume Records
        if (volumeRecords.length > 0) {
          html += '<h3 style="margin-bottom: 1rem;">🏆 Volume Records</h3>';
          volumeRecords.forEach(workout => {
            html += `
              <div class="notable-workout">
                <div class="notable-date">${workout.date}</div>
                <div style="font-weight: 600;">${workout.reason}</div>
                <div style="color: #888; margin-top: 0.25rem;">
                  ${formatVolume(workout.volumeLbs, workout.volumeKg)} • ${workout.details}
                </div>
              </div>
            `;
          });
        }

        // Set Records
        if (setRecords.length > 0) {
          html += '<h3 style="margin-top: 2rem; margin-bottom: 1rem;">💪 Set Records</h3>';
          setRecords.forEach(workout => {
            html += `
              <div class="notable-workout" style="border-left-color: #51cf66;">
                <div class="notable-date">${workout.date}</div>
                <div style="font-weight: 600;">${workout.reason}</div>
                <div style="color: #888; margin-top: 0.25rem;">
                  ${formatVolume(workout.volumeLbs, workout.volumeKg)} • ${workout.details}
                </div>
              </div>
            `;
          });
        }

        // Comebacks
        if (comebacks.length > 0) {
          html += '<h3 style="margin-top: 2rem; margin-bottom: 1rem;">🔥 Comeback Workouts</h3>';
          comebacks.forEach(workout => {
            html += `
              <div class="notable-workout" style="border-left-color: #ffd93d;">
                <div class="notable-date">${workout.date}</div>
                <div style="font-weight: 600;">${workout.reason}</div>
                <div style="color: #888; margin-top: 0.25rem;">
                  ${formatVolume(workout.volumeLbs, workout.volumeKg)} • ${workout.details}
                </div>
              </div>
            `;
          });
        }

        container.innerHTML = html;
      }

      // Scroll spy for navigation
      function updateActiveNav() {
        const sections = document.querySelectorAll("section[id]");
        const navLinks = document.querySelectorAll("nav a");

        let current = "";
        sections.forEach((section) => {
          const sectionTop = section.offsetTop;
          const sectionHeight = section.clientHeight;
          if (window.scrollY >= sectionTop - 100) {
            current = section.getAttribute("id");
          }
        });

        navLinks.forEach((link) => {
          link.classList.remove("active");
          if (link.getAttribute("href") === `#${current}`) {
            link.classList.add("active");
          }
        });
      }

      window.addEventListener("scroll", updateActiveNav);
      window.addEventListener("load", updateActiveNav);

      // Initialize on page load
      init();
    </script>
  </body>
</html>
